services:
  issue-org1:
    container_name: issue-org1
    image: ghcr.io/decaf-ts/fabric-weaver:weaver-${FABRIC_VERSION:-2.5.12}-${WEAVER_VERSION:-latest}
    restart: no
    volumes:
      - boot-files1:/boot:rw
      - org-1-server-vol:/weaver/ca/server:rw
    command: >
      bash -c "
      if [ -f /boot/boot-issuer.lock ]; then
        echo 'Org1 TLS boot is already complete. Skipping...';
        exit 0;
      fi;

      node ./weaver/lib/core/cli.cjs issue-ca -d -s --home /weaver/ca/server --port 7010 --tls-enabled --ca-name org-1 --bootstrap-users org-1:org-1-pw --no-tls-profile --csr-cn org-1 --csr-hosts 0.0.0.0,localhost,org-1 --operations-listen-address 127.0.0.1:8001 --tls-certfile /weaver/client/admin/tls-msp/signcerts/cert.pem --tls-keyfile /weaver/client/admin/tls-msp/signcerts/cert.pem &&

      touch /boot/boot-issuer.lock 
      "

  org-1-tls:
    container_name: org-1-tls
    hostname: org-1-tls
    image: ghcr.io/decaf-ts/fabric-weaver:weaver-${FABRIC_VERSION:-2.5.12}-${WEAVER_VERSION:-latest}
    restart: no
    environment:
      - FABRIC_CA_CLIENT_HOME=/weaver/client/admin
      - FABRIC_CA_SERVER_HOME=/weaver/server
      - FABRIC_CA_CLIENT_TLS_CERTFILES=/weaver/server/ca-cert.pem
    ports:
      - "7001:7001"
    networks:
      org1_network:
    depends_on:
      issue-org1:
        condition: service_completed_successfully
    healthcheck:
      test: bash -c "[ -f /weaver/server/ca-cert.pem ] && curl -s 127.0.0.1:8010/healthz | grep "OK" || exit 1"
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 30s
    volumes:
      - org-1-tls-server-vol:/weaver/server:rw
      - org-1-tls-client-vol:/weaver/server:rw
    command: >
      node ./weaver/lib/core/cli.cjs boot-ca 
      -d 
      -s 
      --home /weaver/server 
      --port 7001 
      --tls-enabled 
      --ca-name org-1-tls 
      --bootstrap-users org-1-tls-admin:org-1-tls-admin-pw 
      --no-ca-profile 
      --csr-cn org-1-tls 
      --csr-hosts 0.0.0.0,localhost,org-1-tls 
      --operations-listen-address 127.0.0.1:8010

  boot-org-1-tls:
    container_name: boot-org-1-tls
    image: ghcr.io/decaf-ts/fabric-weaver:weaver-${FABRIC_VERSION:-2.5.12}-${WEAVER_VERSION:-latest}
    restart: no
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - boot-files1:/boot:rw
    depends_on:
      org-1-tls:
        condition: service_healthy
    command: >
      bash -c "
      if [ -f /boot/boot-org-1-tls.lock ]; then
        echo 'Org 1 TLS already booted. Skipping...';
        exit 0;
      fi;

      apt-get update &&
      apt-get install -y docker.io &&

      docker exec org-1-tls node ./weaver/lib/core/cli.cjs client-enrollment \
      -d --url https://org-1-tls-admin:org-1-tls-admin-pw@org-1-tls:7001 \
      --command enroll && 

      docker exec org-1-tls node ./weaver/lib/core/cli.cjs client-enrollment \
      -d -s --command register \
      --url https://org-1-tls:7001 \
      --id-name org-1-admin \
      --id-secret org-1-admin-pw \
      --tls-certfiles /weaver/server/ca-cert.pem \
      --mspdir /weaver/client/admin/msp &&

      docker exec org-1-tls node ./weaver/lib/core/cli.cjs client-enrollment \
      -d -s --command register \
      --url https://org-1-tls:7001 \
      --id-name org-1-orderer-0-admin \
      --id-secret org-1-orderer-0-admin-pw \
      --tls-certfiles /weaver/server/ca-cert.pem \
      --mspdir /weaver/client/admin/msp &&

      docker exec org-1-tls node ./weaver/lib/core/cli.cjs client-enrollment \
      -d -s --command register \
      --url https://org-1-tls:7001 \
      --id-name org-1-orderer-0 \
      --id-secret org-1-orderer-0 \
      --tls-certfiles /weaver/server/ca-cert.pem \
      --mspdir /weaver/client/admin/msp &&

      docker exec org-1-tls node ./weaver/lib/core/cli.cjs client-enrollment \
      -d -s --command register \
      --url https://org-1-tls:7001 \
      --id-name org-1-peer-0-admin \
      --id-secret org-1-peer-0-admin-pw \
      --tls-certfiles /weaver/server/ca-cert.pem \
      --mspdir /weaver/client/admin/msp &&

      docker exec org-1-tls node ./weaver/lib/core/cli.cjs client-enrollment \
      -d -s --command register \
      --url https://org-1-tls:7001 \
      --id-name org-1-peer-0 \
      --id-secret org-1-peer-0 \
      --tls-certfiles /weaver/server/ca-cert.pem \
      --mspdir /weaver/client/admin/msp &&

      touch /boot/boot-org-1-tls.lock 
      "

volumes:
  boot-files1:
    name: boot-files1

  org-1-tls-server-vol:
    name: org-1-tls-server-vol
  org-1-tls-client-vol:
    name: org-1-tls-client-vol

  org-1-server-vol:
    name: org-1-server-vol

networks:
  org1_network:
    name: org1_network
    driver: bridge
